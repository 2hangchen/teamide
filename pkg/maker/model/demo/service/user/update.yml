name: user/update
inParams:
  - name: user
    type: user
steps:
  # 验证参数合法性
  - if: util.isNull(user)
    error: USER_IS_NULL
  - if: util.isEmpty(user.userId)
    error: USER_ID_IS_EMPTY

  # 查询账号
  - if: util.isNotEmpty(user.account)
    db: count
    table: TB_USER
    wheres:
      - name: account
        value: user.account
    var: countAccount
    steps:
      # 账号存在则抛出相应异常
      - if: countAccount > 0
        error: USER_ACCOUNT_ALREADY_EXIST

  # 更新
  - db: update
    table: TB_USER
    columns:
      - if: util.isNotEmpty(user.name)
        name: name
        value: user.name
      - if: util.isNotEmpty(user.account)
        name: account
        value: user.account
    wheres:
      - name: userId
        value: user.userId
    var: updateCount

  # 账号存在则抛出相应异常
  - if: countAccount == 0
    error: USER_IS_NOT_EXIST

  # 查询用户
  - db: selectOne
    table: TB_USER
    wheres:
      - name: userId
        value: user.userId
    var: selectUser
    varType: user
    steps:
      # 插入redis
      - redis: set
        key: user-${user.userId}
        value: selectUser
        expire: USER_REDIS_EXPIRE

return: user